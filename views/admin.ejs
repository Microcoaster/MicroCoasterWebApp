<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="env" content="<%= process.env.NODE_ENV || 'production' %>">
  <title><%= title %></title>
  <link rel="stylesheet" href="/css/bootstrap-grid.min.css">
  <link rel="stylesheet" href="/css/global.css">
  <link rel="stylesheet" href="/css/dashboard.css">
  <link rel="stylesheet" href="/css/admin.css">
  <link rel="shortcut icon" href="/assets/ico/favicon.ico" type="image/x-icon"/>
</head>
<body class="compact">
  <%- include('partials/navbar', { 
    currentPage: 'admin', 
    user: user
  }) %>

  <div class="container-fluid main-content">
    <main class="content">
      <section class="card panels">
        <div class="container-fluid">
          <div class="row">
            <div class="col-12">
              <div class="admin-container">
      <% if (error) { %>
        <div class="alert alert-error">
          <%= error %>
        </div>
      <% } %>
      
      <% if (success) { %>
        <div class="alert alert-success">
          <%= success %>
        </div>
      <% } %>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
          </div>
          <div class="stat-content">
            <h3 class="stat-total-users"><%= stats.totalUsers %></h3>
            <p>Utilisateurs</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12,6 12,12 16,14"/>
            </svg>
          </div>
          <div class="stat-content">
            <h3 class="stat-online-users"><%= stats.onlineUsers %></h3>
            <p>Utilisateurs en ligne</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="4" y="4" width="16" height="16" rx="2"/>
              <rect x="9" y="9" width="6" height="6"/>
              <line x1="9" y1="1" x2="9" y2="4"/>
              <line x1="15" y1="1" x2="15" y2="4"/>
              <line x1="9" y1="20" x2="9" y2="23"/>
              <line x1="15" y1="20" x2="15" y2="23"/>
              <line x1="20" y1="9" x2="23" y2="9"/>
              <line x1="20" y1="14" x2="23" y2="14"/>
              <line x1="1" y1="9" x2="4" y2="9"/>
              <line x1="1" y1="14" x2="4" y2="14"/>
            </svg>
          </div>
          <div class="stat-content">
            <h3 class="stat-total-modules"><%= stats.totalModules %></h3>
            <p>Modules</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12,6 12,12 16,14"/>
            </svg>
          </div>
          <div class="stat-content">
            <h3 class="stat-online-modules"><%= stats.onlineModules %></h3>
            <p>Modules en ligne</p>
          </div>
        </div>
      </div>

      <div class="admin-sections">
        <div id="usersSection" class="admin-section">
          <div class="section-header">
            <h2>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px; display: inline-block; vertical-align: middle; margin-right: 8px;">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
              </svg>
              Utilisateurs (<%= stats.totalUsers %>)
            </h2>
            <button class="clear-filters-btn-header" id="clearUsersFilters" style="display: none;" title="Effacer tous les filtres">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 6h18"/>
                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                <line x1="10" y1="11" x2="10" y2="17"/>
                <line x1="14" y1="11" x2="14" y2="17"/>
              </svg>
            </button>
          </div>
          <div class="table-container">
            <table class="admin-table" data-table="users">
              <thead>
                <tr>
                  <th class="sortable-header" data-sort="name">
                    <span>Nom</span>
                    <span class="sort-arrow" data-sort="name"></span>
                  </th>
                  <th class="sortable-header" data-sort="email">
                    <span>Email</span>
                    <span class="sort-arrow" data-sort="email"></span>
                  </th>
                  <th class="sortable-header" data-sort="is_admin">
                    <span>Rôle</span>
                    <span class="sort-arrow" data-sort="is_admin"></span>
                  </th>
                  <th class="sortable-header" data-sort="module_count">
                    <span>Modules</span>
                    <span class="sort-arrow" data-sort="module_count"></span>
                  </th>
                  <th class="sortable-header" data-sort="last_login">
                    <span>Dernière connexion</span>
                    <span class="sort-arrow" data-sort="last_login"></span>
                  </th>
                  <th class="sortable-header" data-sort="created_at">
                    <span>Inscription</span>
                    <span class="sort-arrow" data-sort="created_at"></span>
                  </th>
                </tr>
                <tr class="filter-row">
                  <td><input type="text" id="filter-user-name" name="filter-user-name" class="column-filter" data-column="name" placeholder="Filtrer nom..." aria-label="Filtrer par nom d'utilisateur" autocomplete="off" /></td>
                  <td><input type="text" id="filter-user-email" name="filter-user-email" class="column-filter" data-column="email" placeholder="Filtrer email..." aria-label="Filtrer par adresse email" autocomplete="off" /></td>
                  <td>
                    <select id="filter-user-role" name="filter-user-role" class="column-filter" data-column="role" aria-label="Filtrer par rôle utilisateur">
                      <option value="">Tous les rôles</option>
                      <option value="Admin">Admin</option>
                      <option value="Utilisateur">Utilisateur</option>
                    </select>
                  </td>
                  <td><input type="number" id="filter-user-modules" name="filter-user-modules" class="column-filter" data-column="module_count" placeholder="Nb modules..." aria-label="Filtrer par nombre de modules" autocomplete="off" /></td>
                  <td><input type="text" id="filter-user-lastlogin" name="filter-user-lastlogin" class="column-filter" data-column="last_login" placeholder="Filtrer date..." aria-label="Filtrer par date de dernière connexion" autocomplete="off" /></td>
                  <td><input type="text" id="filter-user-created" name="filter-user-created" class="column-filter" data-column="created_at" placeholder="Filtrer date..." aria-label="Filtrer par date de création" autocomplete="off" /></td>
                </tr>
              </thead>
              <tbody>
                <% if (users.length === 0) { %>
                <tr>
                  <td colspan="6" class="empty-state-cell">
                    <div class="empty-state-message">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                        <circle cx="11" cy="11" r="1"/>
                      </svg>
                      <h4>Aucun utilisateur trouvé</h4>
                      <p>Essayez de modifier vos filtres de recherche</p>
                    </div>
                  </td>
                </tr>
                <% } else { %>
                <% users.forEach(user => { %>
                <tr data-user-id="<%= user.id %>">
                  <td class="user-name"><%= user.name %></td>
                  <td class="user-email"><%= user.email %></td>
                  <td>
                    <span class="<%= user.is_admin ? 'badge badge-admin' : 'badge badge-user' %> user-role">
                      <%= user.is_admin ? 'ADMINISTRATEUR' : 'UTILISATEUR' %>
                    </span>
                  </td>
                  <td><%= user.module_count %></td>
                  <td><%= user.last_login ? new Date(user.last_login).toLocaleString('fr-FR') : 'Jamais' %></td>
                  <td><%= new Date(user.created_at).toLocaleDateString('fr-FR') %></td>
                </tr>
                <% }) %>
                <% } %>
              </tbody>
            </table>
          </div>
          
          <div class="pagination-container">
            <div class="items-per-page">
              <label for="usersItemsPerPage">Afficher :</label>
              <select id="usersItemsPerPage" data-table="users" onchange="window.changeItemsPerPage(this)">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
              <span>éléments</span>
            </div>
            <div class="pagination-controls">
              <button 
                class="pagination-prev" 
                data-table="users" 
                onclick="window.navigatePage('users', 'prev', event)">
                ← Précédent
              </button>
              
              <span class="pagination-info" data-table="users">
                Chargement...
              </span>
              
              <button 
                class="pagination-next" 
                data-table="users" 
                onclick="window.navigatePage('users', 'next', event)">
                Suivant →
              </button>
            </div>
          </div>
        </div>

        <div id="modulesSection" class="admin-section">
          <div class="section-header">
            <h2>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px; display: inline-block; vertical-align: middle; margin-right: 8px;">
                <rect x="4" y="4" width="16" height="16" rx="2"/>
                <rect x="9" y="9" width="6" height="6"/>
                <line x1="9" y1="1" x2="9" y2="4"/>
                <line x1="15" y1="1" x2="15" y2="4"/>
                <line x1="9" y1="20" x2="9" y2="23"/>
                <line x1="15" y1="20" x2="15" y2="23"/>
                <line x1="20" y1="9" x2="23" y2="9"/>
                <line x1="20" y1="14" x2="23" y2="14"/>
                <line x1="1" y1="9" x2="4" y2="9"/>
                <line x1="1" y1="14" x2="4" y2="14"/>
              </svg>
              Modules (<%= stats.totalModules %>)
            </h2>
            <button class="clear-filters-btn-header" id="clearModulesFilters" style="display: none;" title="Effacer tous les filtres">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 6h18"/>
                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                <line x1="10" y1="11" x2="10" y2="17"/>
                <line x1="14" y1="11" x2="14" y2="17"/>
              </svg>
            </button>
          </div>
          <div class="table-container">
            <table class="admin-table" data-table="modules">
              <thead>
                <tr>
                  <th class="sortable-header" data-sort="module_id">
                    <span>ID Module</span>
                    <span class="sort-arrow" data-sort="module_id"></span>
                  </th>
                  <th class="sortable-header" data-sort="name">
                    <span>Nom</span>
                    <span class="sort-arrow" data-sort="name"></span>
                  </th>
                  <th class="sortable-header" data-sort="type">
                    <span>Type</span>
                    <span class="sort-arrow" data-sort="type"></span>
                  </th>
                  <th class="sortable-header" data-sort="user_name">
                    <span>Propriétaire</span>
                    <span class="sort-arrow" data-sort="user_name"></span>
                  </th>
                  <th class="sortable-header" data-sort="status">
                    <span>Statut</span>
                    <span class="sort-arrow" data-sort="status"></span>
                  </th>
                  <th class="sortable-header" data-sort="last_seen">
                    <span>Dernière activité</span>
                    <span class="sort-arrow" data-sort="last_seen"></span>
                  </th>
                </tr>
                <tr class="filter-row">
                  <td><input type="text" id="filter-module-id" name="filter-module-id" class="column-filter" data-column="module_id" placeholder="Filtrer ID..." aria-label="Filtrer par ID de module" autocomplete="off" /></td>
                  <td><input type="text" id="filter-module-name" name="filter-module-name" class="column-filter" data-column="name" placeholder="Filtrer nom..." aria-label="Filtrer par nom de module" autocomplete="off" /></td>
                  <td><input type="text" id="filter-module-type" name="filter-module-type" class="column-filter" data-column="type" placeholder="Filtrer type..." aria-label="Filtrer par type de module" autocomplete="off" /></td>
                  <td><input type="text" id="filter-module-owner" name="filter-module-owner" class="column-filter" data-column="user_name" placeholder="Filtrer propriétaire..." aria-label="Filtrer par propriétaire du module" autocomplete="off" /></td>
                  <td>
                    <select id="filter-module-status" name="filter-module-status" class="column-filter" data-column="status" aria-label="Filtrer par statut de module">
                      <option value="">Tous les statuts</option>
                      <option value="En ligne">En ligne</option>
                      <option value="Hors ligne">Hors ligne</option>
                    </select>
                  </td>
                  <td><input type="text" id="filter-module-last-seen" name="filter-module-last-seen" class="column-filter" data-column="last_seen" placeholder="Filtrer date..." aria-label="Filtrer par dernière activité" autocomplete="off" /></td>
                </tr>
              </thead>
              <tbody>
                <% if (modules.length === 0) { %>
                <tr>
                  <td colspan="6" class="empty-state-cell">
                    <div class="empty-state-message">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                        <rect x="9" y="9" width="4" height="4" rx="1"/>
                      </svg>
                      <h4>Aucun module trouvé</h4>
                      <p>Essayez de modifier vos filtres de recherche</p>
                    </div>
                  </td>
                </tr>
                <% } else { %>
                <% modules.forEach(module => { %>
                <tr data-module-id="<%= module.module_id %>">
                  <td><code><%= module.module_id %></code></td>
                  <td><%= module.name || 'Sans nom' %></td>
                  <td>
                    <span data-module-type="<%= module.type || 'Unknown' %>" class="type-badge-container">
                      <%= module.type || 'Inconnu' %>
                    </span>
                  </td>
                  <td><%= module.user_name %></td>
                  <td>
                    <span class="status <%= module.status === 'online' ? 'status-online' : 'status-offline' %>">
                      <%= module.status === 'online' ? 'En ligne' : 'Hors ligne' %>
                    </span>
                  </td>
                  <td>
                    <%= module.lastSeen ? new Date(module.lastSeen).toLocaleString('fr-FR') : 'Jamais' %>
                  </td>
                </tr>
                <% }) %>
                <% } %>
              </tbody>
            </table>
          </div>
          
          <div class="pagination-container">
            <div class="items-per-page">
              <label for="modulesItemsPerPage">Afficher :</label>
              <select id="modulesItemsPerPage" data-table="modules" onchange="window.changeItemsPerPage(this)">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
              <span>éléments</span>
            </div>
            <div class="pagination-controls">
              <button 
                class="pagination-prev" 
                data-table="modules" 
                onclick="window.navigatePage('modules', 'prev', event)">
                ← Précédent
              </button>
              
              <span class="pagination-info" data-table="modules">
                Chargement...
              </span>
              
              <button 
                class="pagination-next" 
                data-table="modules" 
                onclick="window.navigatePage('modules', 'next', event)">
                Suivant →
              </button>
            </div>
          </div>
        </div>
      </div>

      </div>
    </div>
  </div>
</section>
</main>
</div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="/js/global.js"></script>
  <script>
    window.MC = {
      userId: '<%= user.id %>',
      userType: '<%= user.is_admin ? "admin" : "user" %>',
      userName: '<%= user.name %>'
    };
  </script>
  <script src="/js/admin.js"></script>
</body>
</html>