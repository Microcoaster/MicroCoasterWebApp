<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="env" content="<%= process.env.NODE_ENV || 'production' %>">
  <title><%= title %></title>
  <!-- Bootstrap Grid pour la responsivité -->
  <link rel="stylesheet" href="/css/bootstrap-grid.min.css">
  <!-- CSS global -->
  <link rel="stylesheet" href="/css/global.css">
  <!-- CSS pour le style d'encadré -->
  <link rel="stylesheet" href="/css/modules.css">
  <!-- CSS spécifique au dashboard (pour la navbar) -->
  <link rel="stylesheet" href="/css/dashboard.css">
  <!-- CSS spécifique à l'admin -->
  <link rel="stylesheet" href="/css/admin.css">
  <link rel="shortcut icon" href="/assets/ico/favicon.ico" type="image/x-icon"/>
</head>
<body class="compact" 
      data-all-users="<%- encodeURIComponent(JSON.stringify(allUsers)) %>"
      data-all-modules="<%- encodeURIComponent(JSON.stringify(allModules)) %>"
      data-users-sort="<%= pagination.users.sort %>"
      data-users-sort-order="<%= pagination.users.sortOrder %>"
      data-modules-sort="<%= pagination.modules.sort %>"
      data-modules-sort-order="<%= pagination.modules.sortOrder %>">
  <!-- Navbar -->
  <%- include('partials/navbar', { 
    currentPage: 'admin', 
    user: user
  }) %>

  <div class="container-fluid main-content">
    <main class="content">
      <section class="card panels">
        <div class="container-fluid">
          <div class="row">
            <div class="col-12">
              <div class="admin-container">
      
      <% if (error) { %>
        <div class="alert alert-error">
          <%= error %>
        </div>
      <% } %>
      
      <% if (success) { %>
        <div class="alert alert-success">
          <%= success %>
        </div>
      <% } %>

      <!-- Statistiques -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
          </div>
          <div class="stat-content">
            <h3><%= stats.totalUsers %></h3>
            <p>Utilisateurs</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="4" y="4" width="16" height="16" rx="2"/>
              <rect x="9" y="9" width="6" height="6"/>
              <line x1="9" y1="1" x2="9" y2="4"/>
              <line x1="15" y1="1" x2="15" y2="4"/>
              <line x1="9" y1="20" x2="9" y2="23"/>
              <line x1="15" y1="20" x2="15" y2="23"/>
              <line x1="20" y1="9" x2="23" y2="9"/>
              <line x1="20" y1="14" x2="23" y2="14"/>
              <line x1="1" y1="9" x2="4" y2="9"/>
              <line x1="1" y1="14" x2="4" y2="14"/>
            </svg>
          </div>
          <div class="stat-content">
            <h3><%= stats.totalModules %></h3>
            <p>Modules</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12,6 12,12 16,14"/>
            </svg>
          </div>
          <div class="stat-content">
            <h3><%= stats.onlineModules %></h3>
            <p>En ligne</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
          </div>
          <div class="stat-content">
            <h3><%= stats.adminUsers %></h3>
            <p>Admins</p>
          </div>
        </div>
      </div>

      <div class="admin-sections">
        <!-- Section Utilisateurs -->
        <div id="usersSection" class="admin-section">
          <div class="section-header">
            <h2>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px; display: inline-block; vertical-align: middle; margin-right: 8px;">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
              </svg>
              Utilisateurs (<%= stats.totalUsers %>)
            </h2>
            <button class="clear-filters-btn-header" id="clearUsersFilters" style="display: none;" title="Effacer tous les filtres">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 6h18"/>
                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                <line x1="10" y1="11" x2="10" y2="17"/>
                <line x1="14" y1="11" x2="14" y2="17"/>
              </svg>
            </button>
          </div>
          <div class="table-container">
            <table class="admin-table">
              <thead>
                <tr>
                  <th class="sortable-header" data-sort="name">
                    <span>Nom</span>
                    <span class="sort-arrow <%= pagination.users.sort === 'name' ? (pagination.users.sortOrder === 'ASC' ? 'asc' : 'desc') : '' %>" data-sort="name"></span>
                  </th>
                  <th class="sortable-header" data-sort="email">
                    <span>Email</span>
                    <span class="sort-arrow <%= pagination.users.sort === 'email' ? (pagination.users.sortOrder === 'ASC' ? 'asc' : 'desc') : '' %>" data-sort="email"></span>
                  </th>
                  <th class="sortable-header" data-sort="is_admin">
                    <span>Rôle</span>
                    <span class="sort-arrow <%= pagination.users.sort === 'is_admin' ? (pagination.users.sortOrder === 'ASC' ? 'asc' : 'desc') : '' %>" data-sort="is_admin"></span>
                  </th>
                  <th class="sortable-header" data-sort="module_count">
                    <span>Modules</span>
                    <span class="sort-arrow <%= pagination.users.sort === 'module_count' ? (pagination.users.sortOrder === 'ASC' ? 'asc' : 'desc') : '' %>" data-sort="module_count"></span>
                  </th>
                  <th class="sortable-header" data-sort="last_login">
                    <span>Dernière connexion</span>
                    <span class="sort-arrow <%= pagination.users.sort === 'last_login' ? (pagination.users.sortOrder === 'ASC' ? 'asc' : 'desc') : '' %>" data-sort="last_login"></span>
                  </th>
                  <th class="sortable-header" data-sort="created_at">
                    <span>Inscription</span>
                    <span class="sort-arrow <%= pagination.users.sort === 'created_at' ? (pagination.users.sortOrder === 'ASC' ? 'asc' : 'desc') : '' %>" data-sort="created_at"></span>
                  </th>
                </tr>
                <tr class="filter-row">
                  <td><input type="text" id="filter-user-name" name="filter-user-name" class="column-filter" data-column="name" placeholder="Filtrer nom..." value="<%= pagination.users.filters && pagination.users.filters.name || '' %>" aria-label="Filtrer par nom d'utilisateur" autocomplete="off" /></td>
                  <td><input type="text" id="filter-user-email" name="filter-user-email" class="column-filter" data-column="email" placeholder="Filtrer email..." value="<%= pagination.users.filters && pagination.users.filters.email || '' %>" aria-label="Filtrer par adresse email" autocomplete="off" /></td>
                  <td>
                    <select id="filter-user-role" name="filter-user-role" class="column-filter" data-column="role" aria-label="Filtrer par rôle utilisateur">
                      <option value="">Tous les rôles</option>
                      <option value="admin" <%= pagination.users.filters && pagination.users.filters.role === 'admin' ? 'selected' : '' %>>Admin</option>
                      <option value="user" <%= pagination.users.filters && pagination.users.filters.role === 'user' ? 'selected' : '' %>>Utilisateur</option>
                    </select>
                  </td>
                  <td><input type="number" id="filter-user-modules" name="filter-user-modules" class="column-filter" data-column="module_count" placeholder="Nb modules..." value="<%= pagination.users.filters && pagination.users.filters.module_count || '' %>" aria-label="Filtrer par nombre de modules" autocomplete="off" /></td>
                  <td><input type="text" id="filter-user-lastlogin" name="filter-user-lastlogin" class="column-filter" data-column="last_login" placeholder="Filtrer date..." value="<%= pagination.users.filters && pagination.users.filters.last_login || '' %>" aria-label="Filtrer par date de dernière connexion" autocomplete="off" /></td>
                  <td><input type="text" id="filter-user-created" name="filter-user-created" class="column-filter" data-column="created_at" placeholder="Filtrer date..." value="<%= pagination.users.filters && pagination.users.filters.created_at || '' %>" aria-label="Filtrer par date de création" autocomplete="off" /></td>
                </tr>
              </thead>
              <tbody>
                <% if (users.length === 0) { %>
                <tr>
                  <td colspan="6" class="empty-state-cell">
                    <div class="empty-state-message">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                        <circle cx="11" cy="11" r="1"/>
                      </svg>
                      <h4>Aucun utilisateur trouvé</h4>
                      <p>Essayez de modifier vos filtres de recherche</p>
                    </div>
                  </td>
                </tr>
                <% } else { %>
                <% users.forEach(user => { %>
                <tr>
                  <td><%= user.name %></td>
                  <td><%= user.email %></td>
                  <td>
                    <span class="<%= user.is_admin ? 'badge badge-admin' : 'badge badge-user' %>">
                      <%= user.is_admin ? 'Admin' : 'Utilisateur' %>
                    </span>
                  </td>
                  <td><%= user.module_count %></td>
                  <td><%= user.last_login ? new Date(user.last_login).toLocaleString('fr-FR') : 'Jamais' %></td>
                  <td><%= new Date(user.created_at).toLocaleDateString('fr-FR') %></td>
                </tr>
                <% }) %>
                <% } %>
              </tbody>
            </table>
          </div>
          
          <!-- Pagination utilisateurs -->
          <div class="pagination-container">
            <div class="pagination-info">
              Page <%= pagination.users.page %> sur <%= pagination.users.totalPages %> 
              (<%= pagination.users.total %> utilisateurs au total)
            </div>
            <div class="pagination-controls">
              <% if (pagination.users.page > 1) { %>
                <button data-table="users" data-page="<%= pagination.users.page - 1 %>" class="pagination-btn">← Précédent</button>
              <% } %>
              
              <% for (let i = Math.max(1, pagination.users.page - 2); i <= Math.min(pagination.users.totalPages, pagination.users.page + 2); i++) { %>
                <button data-table="users" data-page="<%= i %>" class="pagination-btn <%= i === pagination.users.page ? 'active' : '' %>">
                  <%= i %>
                </button>
              <% } %>
              
              <% if (pagination.users.page < pagination.users.totalPages) { %>
                <button data-table="users" data-page="<%= pagination.users.page + 1 %>" class="pagination-btn">Suivant →</button>
              <% } %>
            </div>
          </div>
        </div>

        <!-- Section Modules -->
        <div id="modulesSection" class="admin-section">
          <div class="section-header">
            <h2>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px; display: inline-block; vertical-align: middle; margin-right: 8px;">
                <rect x="4" y="4" width="16" height="16" rx="2"/>
                <rect x="9" y="9" width="6" height="6"/>
                <line x1="9" y1="1" x2="9" y2="4"/>
                <line x1="15" y1="1" x2="15" y2="4"/>
                <line x1="9" y1="20" x2="9" y2="23"/>
                <line x1="15" y1="20" x2="15" y2="23"/>
                <line x1="20" y1="9" x2="23" y2="9"/>
                <line x1="20" y1="14" x2="23" y2="14"/>
                <line x1="1" y1="9" x2="4" y2="9"/>
                <line x1="1" y1="14" x2="4" y2="14"/>
              </svg>
              Modules (<%= stats.totalModules %>)
            </h2>
            <button class="clear-filters-btn-header" id="clearModulesFilters" style="display: none;" title="Effacer tous les filtres">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 6h18"/>
                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                <line x1="10" y1="11" x2="10" y2="17"/>
                <line x1="14" y1="11" x2="14" y2="17"/>
              </svg>
            </button>
          </div>
          <div class="table-container">
            <table class="admin-table">
              <thead>
                <tr>
                  <th class="sortable-header" data-sort="module_id">
                    <span>ID Module</span>
                    <span class="sort-arrow <%= pagination.modules.sort === 'module_id' ? (pagination.modules.sortOrder === 'ASC' ? 'asc' : 'desc') : '' %>" data-sort="module_id"></span>
                  </th>
                  <th class="sortable-header" data-sort="name">
                    <span>Nom</span>
                    <span class="sort-arrow <%= pagination.modules.sort === 'name' ? (pagination.modules.sortOrder === 'ASC' ? 'asc' : 'desc') : '' %>" data-sort="name"></span>
                  </th>
                  <th class="sortable-header" data-sort="type">
                    <span>Type</span>
                    <span class="sort-arrow <%= pagination.modules.sort === 'type' ? (pagination.modules.sortOrder === 'ASC' ? 'asc' : 'desc') : '' %>" data-sort="type"></span>
                  </th>
                  <th class="sortable-header" data-sort="user_name">
                    <span>Propriétaire</span>
                    <span class="sort-arrow <%= pagination.modules.sort === 'user_name' ? (pagination.modules.sortOrder === 'ASC' ? 'asc' : 'desc') : '' %>" data-sort="user_name"></span>
                  </th>
                  <th class="sortable-header" data-sort="status">
                    <span>Statut</span>
                    <span class="sort-arrow <%= pagination.modules.sort === 'status' ? (pagination.modules.sortOrder === 'ASC' ? 'asc' : 'desc') : '' %>" data-sort="status"></span>
                  </th>
                  <th class="sortable-header" data-sort="last_seen">
                    <span>Dernière activité</span>
                    <span class="sort-arrow <%= pagination.modules.sort === 'last_seen' ? (pagination.modules.sortOrder === 'ASC' ? 'asc' : 'desc') : '' %>" data-sort="last_seen"></span>
                  </th>
                </tr>
                <tr class="filter-row">
                  <td><input type="text" id="filter-module-id" name="filter-module-id" class="column-filter" data-column="module_id" placeholder="Filtrer ID..." value="<%= pagination.modules.filters && pagination.modules.filters.module_id || '' %>" aria-label="Filtrer par ID de module" autocomplete="off" /></td>
                  <td><input type="text" id="filter-module-name" name="filter-module-name" class="column-filter" data-column="name" placeholder="Filtrer nom..." value="<%= pagination.modules.filters && pagination.modules.filters.name || '' %>" aria-label="Filtrer par nom de module" autocomplete="off" /></td>
                  <td><input type="text" id="filter-module-type" name="filter-module-type" class="column-filter" data-column="type" placeholder="Filtrer type..." value="<%= pagination.modules.filters && pagination.modules.filters.type || '' %>" aria-label="Filtrer par type de module" autocomplete="off" /></td>
                  <td><input type="text" id="filter-module-owner" name="filter-module-owner" class="column-filter" data-column="user_name" placeholder="Filtrer propriétaire..." value="<%= pagination.modules.filters && pagination.modules.filters.user_name || '' %>" aria-label="Filtrer par propriétaire du module" autocomplete="off" /></td>
                  <td>
                    <select id="filter-module-status" name="filter-module-status" class="column-filter" data-column="status" aria-label="Filtrer par statut de module">
                      <option value="">Tous les statuts</option>
                      <option value="online" <%= pagination.modules.filters && pagination.modules.filters.status === 'online' ? 'selected' : '' %>>En ligne</option>
                      <option value="offline" <%= pagination.modules.filters && pagination.modules.filters.status === 'offline' ? 'selected' : '' %>>Hors ligne</option>
                    </select>
                  </td>
                  <td><input type="text" id="filter-module-last-seen" name="filter-module-last-seen" class="column-filter" data-column="last_seen" placeholder="Filtrer date..." value="<%= pagination.modules.filters && pagination.modules.filters.last_seen || '' %>" aria-label="Filtrer par dernière activité" autocomplete="off" /></td>
                </tr>
              </thead>
              <tbody>
                <% if (modules.length === 0) { %>
                <tr>
                  <td colspan="6" class="empty-state-cell">
                    <div class="empty-state-message">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                        <rect x="9" y="9" width="4" height="4" rx="1"/>
                      </svg>
                      <h4>Aucun module trouvé</h4>
                      <p>Essayez de modifier vos filtres de recherche</p>
                    </div>
                  </td>
                </tr>
                <% } else { %>
                <% modules.forEach(module => { %>
                <tr>
                  <td><code><%= module.module_id %></code></td>
                  <td><%= module.name || 'Sans nom' %></td>
                  <td><%= module.type || 'Inconnu' %></td>
                  <td><%= module.user_name %></td>
                  <td>
                    <span class="status <%= module.status === 'online' ? 'status-online' : 'status-offline' %>">
                      <%= module.status === 'online' ? 'En ligne' : 'Hors ligne' %>
                    </span>
                  </td>
                  <td>
                    <%= module.lastSeen ? new Date(module.lastSeen).toLocaleString('fr-FR') : 'Jamais' %>
                  </td>
                </tr>
                <% }) %>
                <% } %>
              </tbody>
            </table>
          </div>
          
          <!-- Pagination modules -->
          <div class="pagination-container">
            <div class="pagination-info">
              Page <%= pagination.modules.page %> sur <%= pagination.modules.totalPages %> 
              (<%= pagination.modules.total %> modules au total)
            </div>
            <div class="pagination-controls">
              <% if (pagination.modules.page > 1) { %>
                <button data-table="modules" data-page="<%= pagination.modules.page - 1 %>" class="pagination-btn">← Précédent</button>
              <% } %>
              
              <% for (let i = Math.max(1, pagination.modules.page - 2); i <= Math.min(pagination.modules.totalPages, pagination.modules.page + 2); i++) { %>
                <button data-table="modules" data-page="<%= i %>" class="pagination-btn <%= i === pagination.modules.page ? 'active' : '' %>">
                  <%= i %>
                </button>
              <% } %>
              
              <% if (pagination.modules.page < pagination.modules.totalPages) { %>
                <button data-table="modules" data-page="<%= pagination.modules.page + 1 %>" class="pagination-btn">Suivant →</button>
              <% } %>
            </div>
          </div>
        </div>
      </div>

      </div>
    </div>
  </div>
</section>
</main>
</div>

  <!-- Scripts -->
  <script src="/js/global.js"></script>
  <script src="/js/admin.js"></script>
</body>
</html>