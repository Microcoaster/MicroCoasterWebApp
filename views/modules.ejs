<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="env" content="<%= process.env.NODE_ENV || 'production' %>">
  <title><%= title %></title>
  <link rel="stylesheet" href="/css/bootstrap-grid.min.css">
  <link rel="stylesheet" href="/css/global.css">
  <link rel="stylesheet" href="/css/modules.css">
  <link rel="shortcut icon" href="/assets/ico/favicon.ico" type="image/x-icon"/>
</head>
<body class="compact">

  <%- include('partials/navbar', { currentPage: 'modules', user: user }) %>

  <div class="container-fluid main-content">
      <main class="content">
        <section class="card panels">
          <div class="container-fluid">
            <div class="row">
              <div class="col-12">
                <header class="page-header">
                  <h1 class="page-title">My Modules</h1>
                  <div class="page-actions">
                    <div class="searchbar">
                      <svg class="search-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                      </svg>
                      <input id="moduleSearch" name="moduleSearch" type="text" placeholder="Search modules…" autocomplete="off">
                      <button type="button" class="search-clear" aria-label="Clear">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M18 6L6 18"/>
                          <path d="M6 6l12 12"/>
                        </svg>
                      </button>
                    </div>

                    <label class="toggle">
                      <input type="checkbox" id="filterOnlineOnly" name="filterOnlineOnly">
                      <span>Online only</span>
                    </label>
                    <button id="openModal" class="btn">+ Add module</button>
                  </div>
                </header>
              </div>
            </div>

            <div class="row">
              <div class="col-12">
          <div id="serverState" class="server-state" hidden>
            <div class="server-inner">
              <svg class="srv-ico" viewBox="0 0 24 24" aria-hidden="true">
                <circle cx="12" cy="12" r="10" fill="rgba(239,68,68,.14)"/>
                <path d="M12 7v7" stroke="#ef4444" stroke-width="2" stroke-linecap="round"/>
                <circle cx="12" cy="17" r="1.6" fill="#ef4444"/>
              </svg>
              <div class="srv-copy">
                <h3>Server temporarily unavailable</h3>
                <p>We can't reach the control server. Maintenance may be in progress. We'll keep trying to reconnect.</p>
              </div>
            </div>
          </div>

          <% if (flash) { %>
            <script>
              addEventListener('DOMContentLoaded',()=>showToast('<%= flash %>','info',3000));
            </script>
          <% } %>

          <div id="toasts" class="toasts" aria-live="polite" aria-atomic="true"></div>
          <div id="emptyState" class="empty-state" hidden>
            <div>
              <h3>No online modules available</h3>
              <p>The <strong>Online only</strong> filter is enabled, and no modules are currently connected.</p>
            </div>
          </div>

          <% if (modules.length === 0) { %>
            <div class="empty-state">
              <div>
                <h3>No modules yet</h3>
                <p>Add your first module to get started.</p>
              </div>
            </div>
          <% } %>
              </div>
            </div>

            <div class="row g-1">

          <% modules.forEach(function(module) { %>
            <%
              const moduleId = module.module_id || '';
              const moduleType = module.type || 'Unknown';
              const moduleName = module.name || module.type || moduleType;
            %>
            <div class="col-12 col-lg-6">
              <div class="panel offline disabled" data-type="<%= moduleType %>" data-mid="<%= moduleId %>">
              <button class="kill" type="button" aria-label="Delete this module"></button>
              <div class="h1">
                <%= moduleName %>
                <span class="state offline" data-state>offline</span>
                <span class="alias alias--type" title="Type de module"><%= moduleType %></span>
                <span class="midchip" role="button" title="Cliquer pour copier l'ID">
                  <span class="hash">#</span>
                  <span class="mid" data-mid-text><%= moduleId || '—' %></span>
                </span>
              </div>

              <div class="tiles-grid">
                <% if (moduleType === 'Station') { %>
                  <div class="tile">
                    <div class="label">E-Stop</div>
                    <div class="face">
                      <img data-role="st_estop" class="clickable" src="/assets/img/emergency_button.png" alt="E-STOP">
                    </div>
                  </div>
                  <div class="tile">
                    <div class="label">Next Section Free</div>
                    <div class="face"><img data-role="st_nsf" src="/assets/img/led_off.png" alt="NSF"></div>
                  </div>
                  <div class="tile">
                    <div class="label">Dispatch</div>
                    <div class="face"><img data-role="st_dispatch" class="clickable" src="/assets/img/button_green_off.png" alt="Dispatch"></div>
                  </div>
                  <div class="tile">
                    <div class="label">Gates Open/Closed</div>
                    <div class="face"><img data-role="st_gates" class="clickable" src="/assets/img/switch_0.png" alt="Gates"></div>
                  </div>
                  <div class="tile">
                    <div class="label">Harness Unlock/Lock</div>
                    <div class="face"><img data-role="st_harness" class="clickable" src="/assets/img/switch_0.png" alt="Harness"></div>
                  </div>

                <% } else if (moduleType === 'Switch Track') { %>
                  <div class="tile">
                    <div class="label">Transfer Mode</div>
                    <div class="face"><img data-role="swt_transfer" class="clickable" src="/assets/img/switch_0.png" alt="Transfer"></div>
                  </div>
                  <div class="tile">
                    <div class="label">Switch Left</div>
                    <div class="face"><img data-role="swt_left" src="/assets/img/led_on.png" alt="Left"></div>
                  </div>
                  <div class="tile">
                    <div class="label">Switch Right</div>
                    <div class="face"><img data-role="swt_right" src="/assets/img/led_off.png" alt="Right"></div>
                  </div>

                <% } else if (moduleType === 'Light FX') { %>
                  <div class="tile">
                    <div class="label">Light Switch</div>
                    <div class="face"><img data-role="light_sw" class="clickable" src="/assets/img/switch_0.png" alt="Light Switch"></div>
                  </div>
                  <div class="tile">
                    <div class="label">Light Status</div>
                    <div class="face"><img data-role="light_led" src="/assets/img/led_off.png" alt="Light LED"></div>
                  </div>

                <% } else if (moduleType === 'Launch Track') { %>
                  <div class="tile">
                    <div class="label">Launch Ready</div>
                    <div class="face"><img data-role="ln_ready" src="/assets/img/led_off.png" alt="Ready"></div>
                  </div>
                  <div class="tile">
                    <div class="label">Launch</div>
                    <div class="face"><img data-role="ln_btn" class="clickable" src="/assets/img/button_green_off.png" alt="Launch"></div>
                  </div>
                  <div class="tile">
                    <div class="label">Direction</div>
                    <div class="face">
                      <img data-role="ln_dir" class="clickable" src="/assets/img/switch_0.png" alt="Direction">
                      <div data-role="ln_dir_lbl" class="direction-text">Forward</div>
                    </div>
                  </div>
                  <div class="tile">
                    <div class="label">Speed</div>
                    <div class="face" style="display:grid;place-items:center;gap:8px">
                      <button data-role="ln_gauge" class="gauge clickable" aria-label="Speed">
                        <span class="gauge-val"><b data-role="ln_speed_val">60</b><small>%</small></span>
                      </button>
                      <div class="g-ctrl">
                        <button data-role="ln_minus" class="btn-dark" aria-label="Decrease">−</button>
                        <button data-role="ln_plus"  class="btn-dark" aria-label="Increase">+</button>
                      </div>
                    </div>
                  </div>
                  <div class="tile">
                    <div class="label">Duration</div>
                    <div class="face">
                      <div class="roller" data-role="ln_roll" aria-live="polite" aria-label="Launch duration in seconds">
                        <div class="roller-track" data-role="ln_track"></div>
                        <div class="roller-unit">s</div>
                      </div>
                      <div class="g-ctrl">
                        <button data-role="ln_dur_minus" class="btn-dark" aria-label="Decrease">−</button>
                        <button data-role="ln_dur_plus"  class="btn-dark" aria-label="Increase">+</button>
                      </div>
                    </div>
                  </div>

                <% } else if (moduleType === 'Smoke Machine') { %>
                  <div class="tile">
                    <div class="label">Heater Ready</div>
                    <div class="face"><img data-role="sm_ready" src="/assets/img/led_off.png" alt="Ready"></div>
                  </div>
                  <div class="tile">
                    <div class="label">Smoke</div>
                    <div class="face"><img data-role="sm_btn" class="clickable" src="/assets/img/button_green_off.png" alt="Smoke"></div>
                  </div>
                  <div class="tile">
                    <div class="label">Duration</div>
                    <div class="face">
                      <div class="roller" data-role="sm_roll" aria-live="polite" aria-label="Duration in seconds">
                        <div class="roller-track" data-role="sm_track"></div>
                        <div class="roller-unit">s</div>
                      </div>
                      <div class="g-ctrl">
                        <button data-role="sm_minus" class="btn-dark" aria-label="Decrease">−</button>
                        <button data-role="sm_plus"  class="btn-dark" aria-label="Increase">+</button>
                      </div>
                    </div>
                  </div>

                <% } else if (moduleType === 'Audio Player') { %>
                <div class="tile">
                    <div class="label">Playlist</div>
                    <div class="face">
                    <div class="playlist" data-role="au_list"></div>
                    </div>
                </div>

                <div class="tile">
                    <div class="label">Play</div>
                    <div class="face">
                    <img class="playlamp clickable" data-role="au_play"
                        src="/assets/img/button_green_off.png" alt="Play">
                    </div>
                </div>

                <audio preload="metadata" data-role="au_tag"></audio>

                <% } else { %>
                  <div class="tile">
                    <div class="label">Unknown module</div>
                    <div class="face"><img src="/assets/img/led_off.png" alt="Unknown"></div>
                  </div>
                <% } %>
              </div>
            </div>
            </div>
          <% }); %>

            </div>
          </div>
        </section>
      </main>
    </div>
  </div>
  <div id="modalAdd" class="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="dlgAddTitle">
      <h3 id="dlgAddTitle">Add a module</h3>

      <form method="post" action="/modules/claim" autocomplete="off">
        <div class="form-row">
          <label for="f_mod_id">Module ID</label>
          <input id="f_mod_id" class="input" name="module_id"
                 placeholder="MC-1234-STN" required
                 inputmode="text" autocomplete="off" autocapitalize="none" spellcheck="false"
                 pattern="^MC-\d{4}-(STN|LFX|AP|SM|ST|LT)$"
                 title="Ex. : MC-1234-AP" maxlength="11">
        </div>

        <div class="form-row">
          <label for="f_mod_code">Module code</label>
          <input id="f_mod_code" class="input" name="module_code"
                 placeholder="AB12-CD34" required maxlength="9"
                 inputmode="text" autocomplete="off" autocapitalize="none" spellcheck="false"
                 pattern="^[A-Za-z0-9]{4}-[A-Za-z0-9]{4}$"
                 title="Code de sécurité du module">
        </div>

        <div class="form-row">
          <label for="f_mod_name">Display name (optional)</label>
          <input id="f_mod_name" class="input" name="name"
                 placeholder="My Module Name" autocomplete="off" spellcheck="false">
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-ghost" id="btnCancelAdd">Cancel</button>
          <button type="submit" class="btn">Save</button>
        </div>
      </form>
    </div>
  </div>
  <div id="modalDelete" class="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="dlgDelTitle">
      <h3 id="dlgDelTitle">Delete module</h3>
      <p id="dlgDelText" class="muted" style="margin:8px 0 16px">…</p>

      <form id="deleteForm" method="post">
        <input type="hidden" name="moduleId" id="del_moduleId">
        <div class="modal-actions">
          <button type="button" class="btn btn-ghost" id="btnCancelDel">Cancel</button>
          <button type="submit" class="btn btn-danger">Delete</button>
        </div>
      </form>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="/js/reconnection-manager.js"></script>
  <script src="/js/global.js"></script>
  <script>
    window.MC = { 
      wsCode: '<%= user.code %>',
      userId: '<%= user.id %>',
      userName: '<%= user.name %>'
    };
  </script>
  <script src="/js/modules.js"></script>
</body>
</html>